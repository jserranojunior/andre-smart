<%
'menos_min = request("menos_min")

'**************** Caso a ação seja diferente de "Excluir" **********************
if acao <> "excluir" Then
	minutos = DateDiff("n",cdate(data_entrada),cdate(data_saida))
	min = DateDiff("n",cdate(dt_entr),cdate(dt_saida))
end if
'**************** Se os minutos forem iguais a vazio ***************************
if minutos = "" Then
minutos = 0
end if

cd_minutos_trab = request("cd_minutos_trab")
cd_excedente = request("cd_excedente")
total_geral_trabalhado = request("total_geral_trabalhado")

If cd_minutos_trab <> "" Then
diferenca =  minutos - cd_minutos_trab
Else
diferenca = minutos
End if

novo_excedente = cd_excedente + diferenca

	if cd_minutos_trab <> "" AND acao = "editar" Then ' Se há min_trab e a acao é editar então, 
	min_novo = cd_minutos_trab - minutos
		if int(cd_minutos_trab) > int(min) Then
			response.write("subtrai, ")
			cd_excedente = cd_excedente'utos OK
		elseif int(cd_minutos_trab) < int(min) Then
			response.write("soma, ")
			cd_excedente = cd_excedente' + min
		else
			'cd_excedente = request("cd_excedente")
		end if
	end if
	if cd_minutos_trab = ""  AND acao = "inserir" Then
		cd_excedente = cd_excedente'+ minutos
	end if
%>



		
		'****** Banco de horas ****************************************
		if cd_excedente > 0 Then
			response.write("é maior")
			' Verifica se já existe excedente...
				xsql = "select * from TBL_banco_horas Where cd_funcionario='"&cd_codigo&"' AND dt_mes='"&mesentrada&"' AND dt_ano='"&anoentrada&"'"
				set rs = dbconn.execute(xsql) 
				
				do while NOT rs.EOF
				 'caso não exista, insere o valor excedente no banco de dados...
				 'response.write ("existe!")
				 	cd_existe = rs("cd_codigo")
				rs.movenext
				loop
			if cd_existe = "" Then
				xsql ="up_banco_horas_insert @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&novo_excedente&"', @dt_mes='"&mesentrada&"', @dt_ano='"&anoentrada&"'"
					dbconn.execute(xsql)
					response.write("Banco")
			Else
				xsql ="up_banco_horas_update @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&novo_excedente&"', @cd_existe='"&cd_existe&"'"
					dbconn.execute(xsql)
					response.write("Altera")
			end if
		End if
		'****** Fim dando de horas **************
		
		
<%
if cd_excedente > 0 Then
			response.write("é maior")
			' Verifica se já existe excedente...
				xsql = "select * from TBL_banco_horas Where cd_funcionario='"&cd_codigo&"' AND dt_mes='"&mesentrada&"' AND dt_ano='"&anoentrada&"'"
				set rs = dbconn.execute(xsql) 
				
				do while NOT rs.EOF
				 'caso não exista, insere o valor excedente no banco de dados...
				 'response.write ("existe!")
				 	cd_existe = rs("cd_codigo")
				rs.movenext
				loop
			if cd_existe = "" Then 'Se não existir, insere.
				xsql ="up_banco_horas_insert @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&cd_excedente&"', @dt_mes='"&mesentrada&"', @dt_ano='"&anoentrada&"'"
					dbconn.execute(xsql)
					response.write("Banco")
			Else 'se existir altera
				xsql ="up_banco_horas_update @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&novo_excedente&"', @cd_existe='"&cd_existe&"'"
					dbconn.execute(xsql)
					response.write("Altera")
			end if
		End if
%>

'Altera minutos no banco de horas
				' Verifica se já existe excedente...
				xsql = "select * from TBL_banco_horas Where cd_funcionario='"&cd_codigo&"' AND dt_mes='"&mesentrada&"' AND dt_ano='"&anoentrada&"'"
				set rs = dbconn.execute(xsql) 
				
				do while NOT rs.EOF
				 'caso não exista, insere o valor excedente no banco de dados...
				 'response.write ("existe!")
				 	cd_existe = rs("cd_codigo")
				rs.movenext
				loop
			if cd_existe = "" Then 'Se não existir, insere.
				'xsql ="up_banco_horas_insert @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&cd_excedente&"', @dt_mes='"&mesentrada&"', @dt_ano='"&anoentrada&"'"
				'	dbconn.execute(xsql)
					response.write("Nada a alterar")
			Else 'se existir altera (subtrai)
				'novo_excedente = 
				xsql ="up_banco_horas_update @cd_funcionario="&cd_codigo&",@cd_horas_excedentes='"&novo_excedente&"', @cd_existe='"&cd_existe&"'"
					dbconn.execute(xsql)
					response.write("Altera")
			end if
